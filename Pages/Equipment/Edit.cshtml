@page
@model Proyecto_Laboratorios_Univalle.Pages.Equipment.EditModel

@{
    ViewData["Title"] = "Editor Equipment";
}

<h1>Editar Equipo</h1>

<h4>@Model.ExistingEquipmentDisplay?.Name</h4>
<hr />

<div class="row">
    <div class="col-md-8">
        <form method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <!-- ID is passed via route -->
            <input type="hidden" name="id" value="@Model.Id" />

            <!-- ========================================
                 BASIC INFORMATION
                 ======================================== -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Información Básica</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="Input.Name" class="control-label">
                                    <span class="text-danger">*</span> Nombre del Equipo
                                </label>
                                <input asp-for="Input.Name" class="form-control" required />
                                <span asp-validation-for="Input.Name" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="Input.InventoryNumber" class="control-label">
                                    <span class="text-danger">*</span> N° Inventario
                                </label>
                                <input asp-for="Input.InventoryNumber" class="form-control" required />
                                <span asp-validation-for="Input.InventoryNumber" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="Input.EquipmentTypeId" class="control-label">
                                    <span class="text-danger">*</span> Tipo de Equipo
                                </label>
                                <select asp-for="Input.EquipmentTypeId" class="form-control" asp-items="ViewBag.EquipmentTypeId" required></select>
                                <span asp-validation-for="Input.EquipmentTypeId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="Input.LaboratoryId" class="control-label">
                                    <span class="text-danger">*</span> Laboratorio
                                </label>
                                <select asp-for="Input.LaboratoryId" class="form-control" asp-items="ViewBag.LaboratoryId" required></select>
                                <span asp-validation-for="Input.LaboratoryId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 TECHNICAL SPECS
                 ======================================== -->
            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Especificaciones Técnicas</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Input.Brand" class="control-label"></label>
                                <input asp-for="Input.Brand" class="form-control" />
                                <span asp-validation-for="Input.Brand" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Input.Model" class="control-label"></label>
                                <input asp-for="Input.Model" class="form-control" />
                                <span asp-validation-for="Input.Model" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Input.SerialNumber" class="control-label"></label>
                                <input asp-for="Input.SerialNumber" class="form-control" />
                                <span asp-validation-for="Input.SerialNumber" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 FINANCIAL & LIFECYCLE
                 ======================================== -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Información Financiera</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Input.AcquisitionDate" class="control-label"></label>
                                <input asp-for="Input.AcquisitionDate" class="form-control" type="date" />
                                <span asp-validation-for="Input.AcquisitionDate" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Input.AcquisitionValue" class="control-label"></label>
                                <input asp-for="Input.AcquisitionValue" class="form-control" type="number" step="0.01" />
                                <span asp-validation-for="Input.AcquisitionValue" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Input.UsefulLifeYears" class="control-label"></label>
                                <input asp-for="Input.UsefulLifeYears" class="form-control" type="number" min="0" max="100" />
                                <span asp-validation-for="Input.UsefulLifeYears" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 ORIGIN (Country + City selects relacionados)
                 ======================================== -->
            <div class="card mb-3">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Origen / Ubicación</h5>
                </div>

                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="Input.CountryId" class="control-label">
                                    <span class="text-danger">*</span> País
                                </label>
                                <select asp-for="Input.CountryId" id="countrySelect" class="form-control" asp-items="ViewBag.CountryId" required></select>
                                <span asp-validation-for="Input.CountryId" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="Input.CityId" class="control-label">
                                    <span class="text-danger">*</span> Ciudad
                                </label>
                                <select asp-for="Input.CityId" id="citySelect" class="form-control" asp-items="ViewBag.CityId" required></select>
                                <span asp-validation-for="Input.CityId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-2">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label">País (Derivado de la Ciudad)</label>
                                <!-- Using ExistingEquipmentDisplay for read-only View info -->
                                <input value="@Model.ExistingEquipmentDisplay?.Country?.Name" class="form-control" readonly disabled />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 STATUS & OBSERVATIONS
                 ======================================== -->
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Estado y Observaciones</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="Input.CurrentStatus" class="control-label">
                                    <span class="text-danger">*</span> Estado Actual
                                </label>
                                <select asp-for="Input.CurrentStatus" class="form-control" asp-items="ViewBag.ListaEstadosEquipo" required></select>
                                <span asp-validation-for="Input.CurrentStatus" class="text-danger"></span>
                                <small class="form-text text-muted">Los cambios de estado se guardan automáticamente en el historial.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="Input.Observations" class="control-label"></label>
                                <textarea asp-for="Input.Observations" class="form-control" rows="3"></textarea>
                                <span asp-validation-for="Input.Observations" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 ACTION BUTTONS
                 ======================================== -->
            <div class="form-group mt-3">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Guardar Cambios
                </button>
                <a asp-page="./Index" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancelar
                </a>
                <a asp-page="./Details" asp-route-id="@Model.Id" class="btn btn-info">
                    <i class="fas fa-eye"></i> Ver Detalles
                </a>
            </div>
        </form>
    </div>

    <!-- ========================================
         SIDE PANEL
         ======================================== -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">Información de Registro</h5>
            </div>
            <div class="card-body">
                <p><strong>Creado:</strong> @Model.ExistingEquipmentDisplay?.CreatedDate.ToString("dd/MM/yyyy HH:mm")</p>
                @if (Model.ExistingEquipmentDisplay?.LastModifiedDate.HasValue == true)
                {
                    <p><strong>Modificado:</strong> @Model.ExistingEquipmentDisplay.LastModifiedDate.Value.ToString("dd/MM/yyyy HH:mm")</p>
                }
                @if (Model.ExistingEquipmentDisplay?.AgeYears.HasValue == true)
                {
                    <p><strong>Antigüedad:</strong> @Model.ExistingEquipmentDisplay.AgeYears años</p>
                }
                @if (Model.ExistingEquipmentDisplay?.RequiresReplacement == true)
                {
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle"></i> Requiere Reemplazo.
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var country = document.getElementById('countrySelect');
            var city = document.getElementById('citySelect');

            if (!country || !city) return;

            country.addEventListener('change', function () {
                var countryId = this.value || 0;
                fetch('?handler=Cities&countryId=' + countryId)
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        city.innerHTML = '';
                        // Añadir opción vacía para forzar selección si se desea
                        var emptyOpt = document.createElement('option');
                        emptyOpt.value = '';
                        emptyOpt.text = '-- Seleccione ciudad --';
                        city.appendChild(emptyOpt);

                        data.forEach(function (c) {
                            var opt = document.createElement('option');
                            opt.value = c.id;
                            opt.textContent = c.name;
                            city.appendChild(opt);
                        });
                    })
                    .catch(function (err) {
                        console.error('Error cargando ciudades:', err);
                    });
            });
        });
    </script>
}